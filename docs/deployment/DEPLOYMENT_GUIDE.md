# Backstage App Templating Platform - Deployment Guide

## Quick Start

This guide walks you through deploying the Backstage App Templating Platform to your homelab cluster.

## Prerequisites

Before deploying, ensure you have:

1. **Kubernetes cluster** with Flux GitOps installed
2. **1Password** integration configured (ClusterSecretStore: `onepassword`)
3. **Authentik** instance running at `https://auth.in.hypyr.space`
4. **GitHub** repository access for homelab
5. **kubectl** and **flux** CLI tools installed

## Step 1: Configure Secrets in 1Password

Create a new item in 1Password named `backstage` with the following fields:

```
Title: backstage
Type: Password

Fields:
- GITHUB_TOKEN: <your-github-pat>
  (Scope: repo, read:org)
  
- AUTHENTIK_CLIENT_ID: <authentik-client-id>
  (Generated in Step 2)
  
- AUTHENTIK_CLIENT_SECRET: <authentik-client-secret>
  (Generated in Step 2)
```

### Generate GitHub Personal Access Token

1. Go to GitHub Settings → Developer Settings → Personal Access Tokens → Tokens (classic)
2. Click "Generate new token (classic)"
3. Name: `Backstage Homelab`
4. Scopes: Select `repo` (full control of private repositories)
5. Click "Generate token"
6. Copy token and add to 1Password `backstage` item as `GITHUB_TOKEN`

## Step 2: Configure Authentik OIDC Application

1. Log into Authentik at `https://auth.in.hypyr.space/if/admin/`

2. Navigate to **Applications → Providers** → Click **Create**

3. Create a new **OAuth2/OIDC Provider**:
   ```
   Name: backstage
   Authorization flow: default-provider-authorization-implicit-consent
   Client type: Confidential
   Client ID: <auto-generated>
   Client Secret: <auto-generated>
   Redirect URIs: 
     https://backstage.in.hypyr.space/api/auth/oidc/handler/frame
   ```

4. Click **Create**

5. Navigate to **Applications** → Click **Create**

6. Create a new **Application**:
   ```
   Name: Backstage
   Slug: backstage
   Provider: backstage (select the provider created above)
   ```

7. Click **Create**

8. Copy the **Client ID** and **Client Secret** from the provider and add to 1Password `backstage` item

## Step 3: Deploy to Cluster

The Backstage manifests are already committed to the repository. To deploy:

```bash
# Navigate to repository root
cd /Users/cpritchett/src/personal/homelab

# Verify manifests build correctly
kubectl kustomize kubernetes/clusters/homelab/apps/backstage/

# Commit the changes (if not already committed)
git add kubernetes/clusters/homelab/apps/backstage/
git add backstage/
git commit -m "feat(backstage): deploy Backstage App Templating Platform"

# Push to trigger Flux reconciliation
git push

# Force immediate reconciliation (optional)
flux reconcile source git flux-system
flux reconcile kustomization apps

# Wait for deployment to complete
kubectl -n backstage rollout status deployment/backstage

# Check pod status
kubectl -n backstage get pods
kubectl -n backstage logs -f deployment/backstage
```

## Step 4: Verify Deployment

### Check Pod is Running

```bash
kubectl -n backstage get pods

# Expected output:
# NAME                         READY   STATUS    RESTARTS   AGE
# backstage-xxxxxxxxxx-xxxxx   1/1     Running   0          2m
```

### Check Ingress

```bash
kubectl -n backstage get ingress

# Expected output:
# NAME        CLASS   HOSTS                               ADDRESS         PORTS     AGE
# backstage   nginx   backstage.in.hypyr.space      <ingress-ip>    80, 443   2m
```

### Check ExternalSecret

```bash
kubectl -n backstage get externalsecret

# Expected output:
# NAME        STORE         REFRESH INTERVAL   STATUS   READY
# backstage   onepassword   1h                 Valid    True
```

### Check Logs for Errors

```bash
kubectl -n backstage logs -f deployment/backstage | grep -i error

# No errors should appear
```

## Step 5: Access Backstage UI

1. Open browser and navigate to: **https://backstage.in.hypyr.space**

2. You should be redirected to Authentik login page

3. Login with your Authentik credentials

4. After successful authentication, you should see the Backstage home page

5. Navigate to **Create** in the left sidebar

6. You should see the **Deploy GitOps App** template

## Step 6: Test Template (Manual Verification)

Since the custom TypeScript actions are not yet fully implemented, you can verify the template structure:

1. Click on **Deploy GitOps App** template

2. Verify the form renders with all fields:
   - Application Details (App Name, Container Image, Namespace)
   - Storage Configuration (4 patterns)
   - Ingress & DNS Configuration (2 patterns)
   - Backup Strategy (2 options)

3. Try filling out the form to test validation:
   - App Name with uppercase should show error
   - Invalid storage size should show error
   - Conditional fields should show/hide based on selections

**Note**: Actual manifest generation and Git operations will not work until custom actions are fully implemented.

## Troubleshooting

### Pod Not Starting

```bash
# Check pod events
kubectl -n backstage describe pod <pod-name>

# Check if secrets are available
kubectl -n backstage get secret backstage-secrets -o jsonpath='{.data}' | jq

# Check if PVC is bound
kubectl -n backstage get pvc backstage-data
```

### ExternalSecret Not Ready

```bash
# Check ExternalSecret status
kubectl -n backstage describe externalsecret backstage

# Verify 1Password item exists
kubectl -n external-secrets logs deployment/external-secrets | grep backstage

# Check ClusterSecretStore
kubectl get clustersecretstore onepassword -o yaml
```

### Cannot Access UI

```bash
# Verify Ingress is created
kubectl -n backstage get ingress backstage -o yaml

# Check Ingress controller logs
kubectl -n networking logs -l app.kubernetes.io/name=ingress-nginx

# Verify DNS resolution
nslookup backstage.in.hypyr.space

# Check cert-manager certificate
kubectl -n backstage get certificate backstage-tls
```

### Authentication Not Working

```bash
# Verify Authentik configuration
# - Check redirect URI matches exactly
# - Check client ID/secret are correct in 1Password
# - Check Authentik application is assigned to user

# Check Backstage logs for auth errors
kubectl -n backstage logs -f deployment/backstage | grep -i auth
```

## Next Steps

After successful deployment:

1. **Implement Custom Actions**: Complete TypeScript implementations in `backstage/src/actions/`
2. **Register Actions**: Update Backstage backend to register custom actions
3. **Deploy Updated Code**: Build Backstage Docker image with custom actions and update HelmRelease
4. **Test End-to-End**: Submit a test app deployment via the form
5. **Monitor**: Watch for PR creation and auto-merge behavior

## Rolling Back

If deployment fails or causes issues:

```bash
# Remove Backstage namespace
kubectl delete namespace backstage

# Remove from kustomization
git revert <commit-hash>
git push

# Force Flux reconciliation
flux reconcile source git flux-system
flux reconcile kustomization apps
```

## Support

For issues or questions:

1. Check logs: `kubectl -n backstage logs -f deployment/backstage`
2. Check ExternalSecret: `kubectl -n backstage describe externalsecret backstage`
3. Review implementation status: [IMPLEMENTATION_STATUS.md](IMPLEMENTATION_STATUS.md)
4. Review feature spec: [specs/001-backstage-app-templates/spec.md](specs/001-backstage-app-templates/spec.md)
