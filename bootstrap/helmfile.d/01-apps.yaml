---
# Bootstrap app stack per ADR-0019
# Order: Cilium → CoreDNS → Spegel → cert-manager → External Secrets → 1Password store → kube-vip (control-plane VIP only) → Flux Operator → Flux Instance
# Values are expected in bootstrap/values/*.yaml; files may be injected with secrets via `op inject`.
# Missing value files will warn, not block, but some charts (e.g., 1Password store) need configuration to succeed.

helmDefaults:
  wait: true
  waitForJobs: true
  missingFileHandler: Warn

environments:
  default:
    values:
      - ../values/common.yaml

releases:
  - name: cilium
    namespace: kube-system
    chart: oci://ghcr.io/cilium/charts/cilium
    version: 1.18.5
    values:
      - ../values/cilium.yaml

  - name: coredns
    namespace: kube-system
    chart: oci://ghcr.io/coredns/charts/coredns
    version: 1.45.0
    needs: ['kube-system/cilium']
    values:
      - ../values/coredns.yaml

  - name: spegel
    namespace: kube-system
    chart: oci://ghcr.io/spegel-org/helm-charts/spegel
    version: 0.6.0
    needs: ['kube-system/coredns']
    values:
      - ../values/spegel.yaml

  - name: cert-manager
    namespace: cert-manager
    chart: oci://quay.io/jetstack/charts/cert-manager
    version: v1.19.2
    needs: ['kube-system/spegel']
    values:
      - ../values/cert-manager.yaml

  - name: external-secrets
    namespace: external-secrets
    chart: oci://ghcr.io/external-secrets/charts/external-secrets
    version: 1.2.1
    needs: ['cert-manager/cert-manager']
    values:
      - ../values/external-secrets.yaml

  - name: onepassword-store
    namespace: external-secrets
    chart: oci://ghcr.io/bjw-s-labs/helm/app-template
    version: 4.6.0
    installed: false # enable after providing values in ../values/onepassword-store.yaml
    needs: ['external-secrets/external-secrets']
    values:
      - ../values/onepassword-store.yaml

  - name: kube-vip
    namespace: kube-system
    chart: ghcr.io/kube-vip/helm-charts/kube-vip
    version: 0.6.4
    needs: ['external-secrets/onepassword-store']
    values:
      - ../values/kube-vip.yaml

  - name: flux-operator
    namespace: flux-system
    chart: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator
    version: 0.39.0
    needs: ['kube-system/kube-vip']
    values:
      - ../values/flux-operator.yaml

  - name: flux-instance
    namespace: flux-system
    chart: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-instance
    version: 0.38.1
    needs: ['flux-system/flux-operator']
    values:
      - ../values/flux-instance.yaml
