# Deployment Tiers Contract: Stack Ordering and Dependencies
# Defines the deployment order and tier boundaries (ADR-0022)

---
apiVersion: v1
kind: DeploymentTierContract
metadata:
  name: deployment-tiers
  spec: "002-label-driven-swarm-infrastructure"
  adr: ADR-0022

tiers:
  - name: infrastructure
    order: 1
    deployment_method: bootstrap_script
    script: scripts/truenas-init-bootstrap.sh
    description: >
      Core services required before any other deployment can proceed.
      Deployed once during initial cluster setup. Exception to Komodo
      requirement because Komodo depends on these services.

    stacks:
      - name: op-connect
        path: stacks/infrastructure/op-connect-compose.yaml
        provides: [secrets_management, op_connect_network]
        depends_on: []

      - name: komodo
        path: stacks/infrastructure/komodo-compose.yaml
        provides: [stack_orchestration, git_sync]
        depends_on: [op-connect]

      - name: caddy
        path: stacks/infrastructure/caddy-compose.yaml
        provides: [reverse_proxy, tls_termination, proxy_network]
        depends_on: [op-connect]

  - name: platform
    order: 2
    deployment_method: komodo_ui
    description: >
      Platform services providing observability, authentication,
      monitoring, and CI/CD. Deployed via Komodo UI after
      infrastructure tier is operational.

    stacks:
      - name: observability
        path: stacks/platform/observability/compose.yaml
        provides: [dashboard, uptime_monitoring, label_discovery]
        depends_on: [caddy, op-connect]

      - name: monitoring
        path: stacks/platform/monitoring/compose.yaml
        provides: [metrics, logs, dashboards]
        depends_on: [caddy, op-connect]

      - name: authentik
        path: stacks/platform/auth/authentik/compose.yaml
        provides: [sso, forward_auth, identity]
        depends_on: [caddy, op-connect]

      - name: cloudflared
        path: stacks/infrastructure/cloudflared-compose.yaml
        provides: [external_ingress, webhook_routing]
        depends_on: [caddy, op-connect]

  - name: application
    order: 3
    deployment_method: komodo_ui
    description: >
      User-facing application services. Deployed via Komodo UI
      after platform tier provides necessary infrastructure.

    stacks: []  # No application-tier stacks yet defined

# Network Dependencies
networks:
  - name: proxy_network
    provided_by: caddy
    consumed_by: [all_public_services]
    type: external_overlay

  - name: op-connect_op-connect
    provided_by: op-connect
    consumed_by: [all_secret_hydration_jobs]
    type: external_overlay

# Validation Rules
rules:
  - rule: Infrastructure tier MUST be deployable without Komodo
    rationale: Komodo depends on infrastructure tier

  - rule: Platform/Application tier MUST deploy via Komodo UI
    rationale: ADR-0022 mandates Komodo for NAS stack deployment
    exception: Infrastructure tier (bootstrap dependency)

  - rule: Each stack MUST have a validation script if it requires host-level prerequisites
    rationale: PRE-DEPLOYMENT-VALIDATION-POLICY.md

  - rule: Stacks MUST NOT have circular cross-tier dependencies
    rationale: Prevents deployment deadlocks

  - rule: Scripts CANNOT deploy stacks (only validate/prepare)
    rationale: ADR-0022 â€” Komodo handles deployment
    exception: Infrastructure bootstrap script
