#!/usr/bin/env bash
set -euo pipefail

# Creates/normalizes the Harbor runtime datasets + mountpoints on apps01.
# Safe to run repeatedly.

POOL="apps01"
BASE="${POOL}/appdata/harbor_runtime"
DB="${POOL}/appdata/harbor_db"
REDIS="${POOL}/appdata/harbor_redis"

sudo zfs list -H -o name "${POOL}" >/dev/null

if ! sudo zfs list -H -o name "${BASE}" >/dev/null 2>&1; then
  sudo zfs create -p "${BASE}"
fi
if ! sudo zfs list -H -o name "${DB}" >/dev/null 2>&1; then
  sudo zfs create -p "${DB}"
fi
if ! sudo zfs list -H -o name "${REDIS}" >/dev/null 2>&1; then
  sudo zfs create -p "${REDIS}"
fi

sudo zfs set mountpoint=/mnt/apps01/appdata/harbor/runtime "${BASE}"
sudo zfs set mountpoint=/mnt/apps01/appdata/harbor/runtime/database "${DB}"
sudo zfs set mountpoint=/mnt/apps01/appdata/harbor/runtime/redis "${REDIS}"

# Redis container runs as uid 999 (redis). Ensure ownership.
sudo install -d -m 0750 -o 999 -g 999 /mnt/apps01/appdata/harbor/runtime/redis

# DB runs as postgres inside container (usually uid 999 too in harbor-db image); keep root-owned but writable by container via image init.
sudo install -d -m 0750 /mnt/apps01/appdata/harbor/runtime/database

# Registry root.crt file must be a FILE (not dir) for bind mount.
sudo install -d -m 0755 /mnt/apps01/appdata/harbor/runtime/secret/registry
# Create an empty placeholder file only if missing so we don't clobber a real cert.
# The actual certificate contents are managed outside this script and may overwrite
# the placeholder at runtime.
if [[ -e /mnt/apps01/appdata/harbor/runtime/secret/registry/root.crt && ! -f /mnt/apps01/appdata/harbor/runtime/secret/registry/root.crt ]]; then
  echo "ERROR: /mnt/apps01/appdata/harbor/runtime/secret/registry/root.crt exists but is not a regular file." >&2
  exit 1
fi
if [[ ! -f /mnt/apps01/appdata/harbor/runtime/secret/registry/root.crt ]]; then
  sudo install -m 0644 /dev/null /mnt/apps01/appdata/harbor/runtime/secret/registry/root.crt
fi

echo "Harbor datasets/mounts normalized."
sudo zfs get -H -o name,property,value mountpoint "${BASE}" "${DB}" "${REDIS}"
