#!/usr/bin/env bash
set -euo pipefail

# Pull only the subpaths we need from GitHub and deploy.
# This keeps the NAS clean: no full monorepo checkout required.

REPO="${HOMELAB_REPO:-cpritchett/homelab}"
BRANCH="${HOMELAB_BRANCH:-main}"
DEST="${HOMELAB_DEST:-/mnt/apps01/appdata/stacks/homelab}"

need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing: $1" >&2; exit 1; }; }
need git
need sudo

mkdir -p "${DEST}"
if [[ ! -d "${DEST}/.git" ]]; then
  git -C "${DEST}" init
  git -C "${DEST}" remote add origin "https://github.com/${REPO}.git"
  git -C "${DEST}" config core.sparseCheckout true
  git -C "${DEST}" sparse-checkout init --cone
  git -C "${DEST}" sparse-checkout set stacks docs
fi

git -C "${DEST}" fetch --depth 1 origin "${BRANCH}" || {
  echo "ERROR: git fetch failed" >&2
  exit 1
}
git -C "${DEST}" reset --hard "origin/${BRANCH}" || {
  echo "ERROR: git reset failed" >&2
  exit 1
}

# Ensure our helper binaries are in the expected place
sudo install -d -m 0755 -o root -g root /mnt/apps01/appdata/bin
sudo install -m 0755 -o root -g root "${DEST}/stacks/_bin/op-inject" /mnt/apps01/appdata/bin/op-inject

"${DEST}/stacks/_bin/deploy-all"
