#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Order matters:
# - 00-proxy first (caddy)
# - then stacks that rely on proxy_network
STACKS=(
  "${ROOT_DIR}/00-proxy"
  "${ROOT_DIR}/20-harbor"
)

SUCCEEDED=()
FAILED=()

for s in "${STACKS[@]}"; do
  echo "== Deploying: ${s}"
  if "${ROOT_DIR}/_bin/deploy-stack" "${s}"; then
    SUCCEEDED+=("${s}")
  else
    echo "!! Deployment FAILED for: ${s}" >&2
    FAILED+=("${s}")
  fi
done

echo
echo "== Deployment summary =="

if ((${#SUCCEEDED[@]})); then
  echo "Succeeded:"
  for s in "${SUCCEEDED[@]}"; do
    echo "  - ${s}"
  done
else
  echo "No stacks were successfully deployed."
fi

if ((${#FAILED[@]})); then
  echo
  echo "Failed:"
  for s in "${FAILED[@]}"; do
    echo "  - ${s}"
  done
  exit 1
fi

exit 0
