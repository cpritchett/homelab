#!/usr/bin/env bash
set -euo pipefail

# Deploy a single stack given its absolute path
# Runs render-env.sh if present, then docker compose pull/up

STACK_DIR="${1:-}"
[[ -n "${STACK_DIR}" ]] || { echo "Usage: deploy-stack <stack-dir>"; exit 2; }

cd "${STACK_DIR}"

# Render .env from .env.tpl if both exist
if [[ -f ./render-env.sh && -f ./.env.tpl ]]; then
  echo "Rendering environment for $(basename "${STACK_DIR}")"
  ./render-env.sh
fi

echo "Deploying stack: $(basename "${STACK_DIR}")"

# docker compose must run with sudo on TrueNAS
sudo docker compose pull
sudo docker compose up -d --remove-orphans
sudo docker compose ps
