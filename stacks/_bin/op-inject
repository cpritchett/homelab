#!/usr/bin/env bash
set -euo pipefail

# Runs 1Password CLI in a container with persistent cache
# Supports injecting .env.tpl → .env and general op CLI usage

TOKEN_FILE_DEFAULT="/mnt/apps01/appdata/secrets/1password/op_service_account_token"
TOKEN_FILE="${OP_TOKEN_FILE:-${TOKEN_FILE_DEFAULT}}"
[[ -r "${TOKEN_FILE}" ]] || { echo "ERROR: token not readable at: ${TOKEN_FILE}" >&2; exit 1; }

OP_SERVICE_ACCOUNT_TOKEN="$(tr -d '\r\n' < "${TOKEN_FILE}")"
if [[ -z "${OP_SERVICE_ACCOUNT_TOKEN}" || "${OP_SERVICE_ACCOUNT_TOKEN}" == PASTE_* ]]; then
  echo "ERROR: OP service account token file looks empty or placeholder: ${TOKEN_FILE}" >&2
  exit 1
fi

WORKDIR="$(pwd)"
CACHE_BASE="${OP_CACHE_BASE:-/mnt/apps01/appdata/secrets/1password/op-cache}"
USER_ID="$(id -u)"
GROUP_ID="$(id -g)"
UID_GID="${USER_ID}:${GROUP_ID}"
CACHE_DIR="${CACHE_BASE}/${USER_ID}_${GROUP_ID}"

# Create cache directories with proper permissions
mkdir -p "${CACHE_DIR}/config" "${CACHE_DIR}/data" "${CACHE_DIR}/home" "${CACHE_DIR}/tmp"
if ! chmod 700 "${CACHE_DIR}" "${CACHE_DIR}/config" "${CACHE_DIR}/data" "${CACHE_DIR}/home" "${CACHE_DIR}/tmp"; then
  echo "WARNING: failed to set permissions (700) on 1Password cache directories under: ${CACHE_DIR}" >&2
fi

OP_IMAGE="${OP_IMAGE:-1password/op:2}"

# Verify that we can run docker with sudo non-interactively before exec'ing
if ! sudo -n docker version >/dev/null 2>&1; then
  echo "ERROR: This script requires non-interactive 'sudo docker' access." >&2
  echo "       Ensure your user can run 'sudo docker' without being prompted for a password." >&2
  exit 1
fi

# Special handling for .env.tpl injection
if [[ $# -eq 2 && "$1" == "inject" && -f "$2" ]]; then
  ENV_TPL_FILE="$2"
  ENV_FILE="${ENV_TPL_FILE%.tpl}"
  
  echo "Injecting secrets from ${ENV_TPL_FILE} → ${ENV_FILE}"
  
  exec sudo docker run --rm \
    --user "${UID_GID}" \
    -e OP_SERVICE_ACCOUNT_TOKEN="${OP_SERVICE_ACCOUNT_TOKEN}" \
    -e HOME="/home/op" \
    -e XDG_CONFIG_HOME="/home/op/.config" \
    -e XDG_DATA_HOME="/home/op/.local/share" \
    -v "${WORKDIR}:/work" \
    -w /work \
    -v "${CACHE_DIR}/home:/home/op" \
    -v "${CACHE_DIR}/config:/home/op/.config" \
    -v "${CACHE_DIR}/data:/home/op/.local/share" \
    -v "${CACHE_DIR}/tmp:/tmp" \
    "${OP_IMAGE}" op inject -i "${ENV_TPL_FILE}" -o "${ENV_FILE}"
else
  # General op CLI usage
  exec sudo docker run --rm \
    --user "${UID_GID}" \
    -e OP_SERVICE_ACCOUNT_TOKEN="${OP_SERVICE_ACCOUNT_TOKEN}" \
    -e HOME="/home/op" \
    -e XDG_CONFIG_HOME="/home/op/.config" \
    -e XDG_DATA_HOME="/home/op/.local/share" \
    -v "${WORKDIR}:/work" \
    -w /work \
    -v "${CACHE_DIR}/home:/home/op" \
    -v "${CACHE_DIR}/config:/home/op/.config" \
    -v "${CACHE_DIR}/data:/home/op/.local/share" \
    -v "${CACHE_DIR}/tmp:/tmp" \
    "${OP_IMAGE}" op "$@"
fi
