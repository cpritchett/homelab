services:
  caddy:
    image: ghcr.io/cpritchett/caddy-labels:latest
    restart: unless-stopped
    user: "${PUID:-1701}:${PGID:-1702}"

    environment:
      TZ: "${TZ:-America/Chicago}"
      CADDY_EMAIL: "${CADDY_EMAIL:-you@example.com}"
      CADDY_INGRESS_NETWORKS: proxy_network
      CLOUDFLARE_API_TOKEN: "${CLOUDFLARE_API_TOKEN}"
      DOCKER_HOST: tcp://docker-socket-proxy:2375

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ${APPDATA:-/mnt/apps01/appdata/proxy}/caddy-data:/data/caddy
      - ${APPDATA:-/mnt/apps01/appdata/proxy}/caddy-config:/config

    networks:
      - proxy_network

    depends_on:
      docker-socket-proxy:
        condition: service_healthy

    # Optional hardening (enable if it doesn't break)
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    labels:
      caddy.email: "${CADDY_EMAIL:-you@example.com}"

      # Barbary UI (TrueNAS)
      caddy_0: barbary.in.hypyr.space
      caddy_0.reverse_proxy: https://10.0.5.121:444
      caddy_0.reverse_proxy.transport: http  # transport for HTTPS backend
      caddy_0.reverse_proxy.transport.tls_server_name: barbary.in.hypyr.space
      caddy_0.reverse_proxy.transport.tls_insecure_skip_verify: ""

      # Wildcard seed / fallback
      caddy_1: "*.in.hypyr.space in.hypyr.space"
      caddy_1.respond: "ok 200"
      caddy_1.tls.dns: cloudflare {env.CLOUDFLARE_API_TOKEN}

  docker-socket-proxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:0.1.2@sha256:dc8ec925b1360c54e6bf350602d6faac4e33c5d8d809118e4c000c0b14a4529a
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    environment:
      CONTAINERS: "1"
      NETWORKS: "1"
      EVENTS: "1"
      INFO: "1"
      PING: "1"
      # Enable for Docker Swarm service/task discovery (not required for standalone Compose)
      # SERVICES: "1"
      # TASKS: "1"

    networks:
      - proxy_network

    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:2375/_ping"]
      interval: 10s
      timeout: 3s
      retries: 10

    # Optional hardening - test before enabling, socket proxy may need specific capabilities
    security_opt:
      - no-new-privileges:true
    # cap_drop:
    #   - ALL

networks:
  proxy_network:
    external: true
