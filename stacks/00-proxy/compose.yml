version: "3.9"

services:
  caddy:
    image: ghcr.io/cpritchett/caddy-labels:latest
    container_name: caddy
    restart: unless-stopped
    user: "1701:1702"

    environment:
      TZ: "${TZ}"
      CADDY_EMAIL: "${CADDY_EMAIL}"
      CADDY_INGRESS_NETWORKS: proxy_network
      CLOUDFLARE_API_TOKEN: "${CLOUDFLARE_API_TOKEN}"
      DOCKER_HOST: tcp://docker-socket-proxy:2375

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ${CADDY_DATA_PATH:-/mnt/apps01/appdata/proxy/caddy-data}:/data/caddy
      - ${CADDY_CONFIG_PATH:-/mnt/apps01/appdata/proxy/caddy-config}:/config

    networks:
      - proxy_network

    depends_on:
      docker-socket-proxy:
        condition: service_healthy

    labels:
      caddy.email: "${CADDY_EMAIL}"

      # Barbary UI (TrueNAS)
      caddy_0: barbary.in.hypyr.space
      caddy_0.reverse_proxy: https://10.0.5.121:444
      caddy_0.reverse_proxy.transport: http
      caddy_0.reverse_proxy.transport.tls_server_name: barbary.in.hypyr.space
      caddy_0.reverse_proxy.transport.tls_insecure_skip_verify: ""

      # Wildcard seed / fallback
      caddy_1: "*.in.hypyr.space in.hypyr.space"
      caddy_1.respond: "ok 200"
      caddy_1.tls.dns: cloudflare {env.CLOUDFLARE_API_TOKEN}

  docker-socket-proxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:0.1.1
    container_name: docker-socket-proxy
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    environment:
      CONTAINERS: "1"
      NETWORKS: "1"
      EVENTS: "1"
      INFO: "1"
      PING: "1"

    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:2375/_ping"]
      interval: 10s
      timeout: 3s
      retries: 10

    networks:
      - proxy_network

networks:
  proxy_network:
    external: true
