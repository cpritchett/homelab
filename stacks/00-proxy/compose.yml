services:
  caddy:
    image: ghcr.io/cpritchett/caddy-labels:latest
    container_name: caddy
    restart: unless-stopped
    user: "1701:1702"
    environment:
      CADDY_INGRESS_NETWORKS: proxy_network
      TZ: "${TZ}"
      CLOUDFLARE_API_TOKEN: "${CLOUDFLARE_TOKEN}"
      DOCKER_HOST: tcp://docker-socket-proxy:2375
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /mnt/apps01/appdata/proxy/caddy-data:/data/caddy
      - /mnt/apps01/appdata/proxy/caddy-config:/config
    networks:
      - proxy_network
    depends_on:
      docker-socket-proxy:
        condition: service_healthy
    labels:
      caddy.email: "${CADDY_EMAIL}"

      # Barbary UI (non-docker service)
      caddy_0: "barbary.in.hypyr.space"
      caddy_0.reverse_proxy: "https://10.0.5.121:444"
      caddy_0.reverse_proxy.transport: "http"
      caddy_0.reverse_proxy.transport.tls_server_name: "barbary.in.hypyr.space"
      caddy_0.reverse_proxy.transport.tls_insecure_skip_verify: ""

      # Wildcard cert seeding / fallback
      caddy_1: "*.in.hypyr.space in.hypyr.space"
      caddy_1.respond: "ok 200"
      caddy_1.tls.dns: "cloudflare {env.CLOUDFLARE_API_TOKEN}"

  docker-socket-proxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    restart: unless-stopped
    networks:
      - proxy_network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      CONTAINERS: "1"
      SERVICES: "1"
      NETWORKS: "1"
      TASKS: "1"
      INFO: "1"
      EVENTS: "1"
      PING: "1"
      TIMEOUT_CONNECT: 5s
      TIMEOUT_CLIENT: 30s
      TIMEOUT_SERVER: 30s
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:2375/_ping"]
      interval: 10s
      timeout: 3s
      retries: 10

networks:
  proxy_network:
    external: true
