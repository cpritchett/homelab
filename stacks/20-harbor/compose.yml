services:
  log:
    image: goharbor/harbor-log:v2.14.1
    container_name: harbor-log
    restart: always
    cap_drop: [ "ALL" ]
    cap_add: [ "CHOWN", "SETGID", "SETUID" ]
    volumes:
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime
        target: /var/log/docker
    ports:
      - "127.0.0.1:1514:10514"
    networks: [ harbor ]
    logging:
      driver: "json-file"
      options:
        max-size: "200k"
        max-file: "10"

  registry:
    image: goharbor/registry-photon:v2.14.1
    container_name: registry
    restart: always
    cap_drop: [ "ALL" ]
    cap_add: [ "CHOWN", "SETGID", "SETUID" ]
    volumes:
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/registry
        target: /storage
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/config/registry
        target: /etc/registry
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/secret/registry/root.crt
        target: /etc/registry/root.crt
        read_only: true
    networks: [ harbor ]
    depends_on: [ log ]
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://localhost:1514"
        tag: "registry"

  registryctl:
    image: goharbor/harbor-registryctl:v2.14.1
    container_name: registryctl
    restart: always
    cap_drop: [ "ALL" ]
    cap_add: [ "CHOWN", "SETGID", "SETUID" ]
    volumes:
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/config/registryctl
        target: /etc/registryctl
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/secret/registry/root.crt
        target: /etc/registry/root.crt
        read_only: true
    networks: [ harbor ]
    depends_on: [ log ]
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://localhost:1514"
        tag: "registryctl"

  postgresql:
    image: goharbor/harbor-db:v2.14.1
    container_name: harbor-db
    restart: always
    cap_drop: [ "ALL" ]
    cap_add: [ "CHOWN", "SETGID", "SETUID" ]
    environment:
      POSTGRES_PASSWORD: "${HARBOR_DB_PASSWORD}"
      POSTGRES_DB: registry
      POSTGRES_USER: postgres
    volumes:
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/database
        target: /var/lib/postgresql/data
    networks: [ harbor ]
    depends_on: [ log ]
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://localhost:1514"
        tag: "postgresql"

  redis:
    image: goharbor/redis-photon:v2.14.1
    container_name: redis
    restart: always
    cap_drop: [ "ALL" ]
    cap_add: [ "CHOWN", "SETGID", "SETUID" ]
    command: ["redis-server","/etc/redis.conf","--dir","/var/lib/redis","--pidfile","/var/lib/redis/redis.pid"]
    volumes:
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/redis
        target: /var/lib/redis
    networks: [ harbor ]
    depends_on: [ log ]
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://localhost:1514"
        tag: "redis"

  core:
    image: goharbor/harbor-core:v2.14.1
    container_name: harbor-core
    restart: always
    cap_drop: [ "ALL" ]
    cap_add: [ "CHOWN", "SETGID", "SETUID" ]
    environment:
      CORE_SECRET: "${HARBOR_CORE_SECRET}"
      JOBSERVICE_SECRET: "${HARBOR_JOBSERVICE_SECRET}"
      HARBOR_ADMIN_PASSWORD: "${HARBOR_ADMIN_PASSWORD}"
      DATABASE_TYPE: postgresql
      POSTGRESQL_HOST: postgresql
      POSTGRESQL_PORT: 5432
      POSTGRESQL_USERNAME: postgres
      POSTGRESQL_PASSWORD: "${HARBOR_DB_PASSWORD}"
      POSTGRESQL_DATABASE: registry
      REGISTRY_URL: http://registry:5000
      REGISTRY_CONTROLLER_URL: http://registryctl:8080
      _REDIS_URL_CORE: redis://redis:6379?idle_timeout_seconds=30
      _REDIS_URL_REG: redis://redis:6379/1?idle_timeout_seconds=30
    volumes:
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/config/core
        target: /etc/core
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/secret/core/private_key.pem
        target: /etc/core/private_key.pem
        read_only: true
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/secret/keys/secretkey
        target: /etc/core/key
        read_only: true
    networks: [ harbor ]
    depends_on: [ log, postgresql, redis, registry, registryctl ]
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://localhost:1514"
        tag: "core"

  portal:
    image: goharbor/harbor-portal:v2.14.1
    container_name: harbor-portal
    restart: always
    cap_drop: [ "ALL" ]
    cap_add: [ "CHOWN", "SETGID", "SETUID", "NET_BIND_SERVICE" ]
    volumes:
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/config/portal/nginx.conf
        target: /etc/nginx/nginx.conf
    networks: [ harbor ]
    depends_on: [ log ]
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://localhost:1514"
        tag: "portal"

  jobservice:
    image: goharbor/harbor-jobservice:v2.14.1
    container_name: harbor-jobservice
    restart: always
    cap_drop: [ "ALL" ]
    cap_add: [ "CHOWN", "SETGID", "SETUID" ]
    environment:
      CORE_SECRET: "${HARBOR_CORE_SECRET}"
      JOBSERVICE_SECRET: "${HARBOR_JOBSERVICE_SECRET}"
    volumes:
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/config/jobservice
        target: /etc/jobservice
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/secret/core/private_key.pem
        target: /etc/jobservice/private_key.pem
        read_only: true
    networks: [ harbor ]
    depends_on: [ log, core ]
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://localhost:1514"
        tag: "jobservice"

  proxy:
    image: goharbor/nginx-photon:v2.14.1
    container_name: nginx
    restart: always
    cap_drop: [ "ALL" ]
    cap_add: [ "CHOWN", "SETGID", "SETUID", "NET_BIND_SERVICE" ]
    volumes:
      - /mnt/apps01/appdata/harbor/runtime/config/nginx:/etc/nginx:ro
      - type: bind
        source: /mnt/apps01/appdata/harbor/runtime/config/shared/trust-certificates
        target: /harbor_cust_cert
        read_only: true
    networks:
      - harbor
      - proxy_network
    # No host ports â€” Caddy terminates 80/443 and routes internally.
    labels:
      caddy: "harbor.in.hypyr.space"
      caddy.tls.dns: "cloudflare {env.CLOUDFLARE_API_TOKEN}"
      caddy.reverse_proxy: "{{upstreams 8080}}"
    depends_on: [ registry, core, portal, log ]
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://localhost:1514"
        tag: "proxy"

networks:
  harbor:
    name: harbor_harbor
  proxy_network:
    external: true
