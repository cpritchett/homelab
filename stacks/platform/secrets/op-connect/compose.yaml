services:
  op-connect-api:
    image: 1password/connect-api:1.7.3
    hostname: op-connect-api
    deploy:
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 0
      placement:
        constraints:
          - node.hostname == barbary
    volumes:
      - op-connect-data:/home/opuser/.op/data
      - /mnt/apps01/secrets/op/1password-credentials.json:/home/opuser/.op/1password-credentials.json:ro
    environment:
      OP_SESSION: /home/opuser/.op/1password-credentials.json
      OP_LOG_LEVEL: ${OP_LOG_LEVEL:-info}
    secrets:
      - CLOUDFLARE_API_TOKEN
    labels:
      caddy: op-connect.in.hypyr.space
      caddy.reverse_proxy: "op-connect-api:8080"
      caddy.tls.dns: "cloudflare {env.CLOUDFLARE_API_TOKEN}"
    networks:
      op-connect:
        aliases:
          - op-connect-api
      proxy_network:
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  op-connect-sync:
    image: 1password/connect-sync:1.7.3
    hostname: op-connect-sync
    deploy:
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 0
      placement:
        constraints:
          - node.hostname == barbary
    volumes:
      - op-connect-data:/home/opuser/.op/data
      - /mnt/apps01/secrets/op/1password-credentials.json:/home/opuser/.op/1password-credentials.json:ro
    environment:
      OP_SESSION: /home/opuser/.op/1password-credentials.json
      OP_LOG_LEVEL: ${OP_LOG_LEVEL:-info}
    networks:
      op-connect:
        aliases:
          - op-connect-sync
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_:
    driver: overlay
    attachable: tru
networks:
  op-connect-internal:
    driver: bridge
  proxy_network:
    external: true

volumes:
  op-connect-data:
    driver: local

secrets:
  CLOUDFLARE_API_TOKEN:
    external: true
