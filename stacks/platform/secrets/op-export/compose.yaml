services:
  op-export:
    image: alpine:3.20
    restart: "no"
    env_file:
      - /mnt/apps01/secrets/op/op.env
    volumes:
      - type: bind
        source: /mnt/apps01
        target: /mnt/apps01
    working_dir: /mnt/apps01
    entrypoint: ["/bin/sh","-lc"]
    command: >
      set -euo pipefail;
      apk add --no-cache ca-certificates curl jq unzip >/dev/null;
      OP_VERSION="2.30.3";
      OP_SHA256="3500bcec4ae3e478d8f3fd711e00e9567e33d0bb5c9d719ed2c6e2c0172e5479";
      curl -fsSL "https://cache.agilebits.com/dist/1P/op2/pkg/v${OP_VERSION}/op_linux_amd64_v${OP_VERSION}.zip" -o /tmp/op.zip;
      echo "${OP_SHA256}  /tmp/op.zip" | sha256sum -c -;
      unzip -p /tmp/op.zip op > /usr/local/bin/op;
      chmod +x /usr/local/bin/op;
      for s in $${STACKS}; do
        /mnt/apps01/scripts/op-export-stack-env.sh "$${s}";
      done
