services:
  secrets-init:
    image: 1password/op:2@sha256:4ac3658f1e91a27ec9503f2134d4b2b77769b36d35b2e370ac89b5976573a17b
    deploy:
      mode: replicated-job
      restart_policy:
        condition: none
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    environment:
      OP_CONNECT_HOST: http://op-connect-api:8080
      OP_CONNECT_TOKEN_FILE: /run/secrets/op_connect_token
    secrets:
      - op_connect_token
    volumes:
      - ./env.template:/templates/restic.template:ro
      - /mnt/apps01/appdata/restic/secrets:/secrets
    networks:
      - op-connect
    command: >
      sh -ec "
      export OP_CONNECT_TOKEN=$$(cat /run/secrets/op_connect_token) &&
      op inject -i /templates/restic.template -o /secrets/restic.env -f &&
      chmod 644 /secrets/restic.env &&
      echo 'Secrets injected successfully'
      "

  restic:
    image: restic/restic:0.18.1@sha256:39d9072fb5651c80d75c7a811612eb60b4c06b32ffe87c2e9f3c7222e1797e76
    deploy:
      replicas: 0
      placement:
        constraints:
          - node.hostname == barbary
      restart_policy:
        condition: none
      resources:
        limits:
          cpus: '2'
          memory: 2048M
    environment:
      # Set by Komodo when running job: backup | prune | check | snapshots
      RESTIC_TASK: backup
      # Tag snapshots
      RESTIC_HOST: barbary
      RESTIC_TAGS: "homelab,barbary,truenas"
      # Cache on fast storage
      RESTIC_CACHE_DIR: /cache
    volumes:
      - /mnt/apps01/appdata/restic/secrets:/secrets:ro
      - type: bind
        source: /mnt/apps01
        target: /src/apps01
        read_only: true
      - type: bind
        source: /mnt/data01
        target: /src/data01
        read_only: true
      - type: bind
        source: /mnt/apps01/appdata/restic/cache
        target: /cache
      - type: bind
        source: ./run.sh
        target: /scripts/run.sh
        read_only: true
      - type: bind
        source: ./excludes.txt
        target: /scripts/excludes.txt
        read_only: true
    networks:
      - op-connect
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "set -a && [ -f /secrets/restic.env ] && . /secrets/restic.env && set +a &&
       exec /scripts/run.sh"

networks:
  op-connect:
    name: op-connect_op-connect
    external: true

secrets:
  op_connect_token:
    external: true
