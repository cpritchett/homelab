services:
  secrets-init:
    image: 1password/op:2@sha256:57d7d6a2bb2b74b2cf8111f6afb2973c74772198f82ea30359a53faae9fff5b1
    deploy:
      mode: replicated-job
      restart_policy:
        condition: none
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    environment:
      OP_CONNECT_HOST: http://op-connect-api:8080
      OP_CONNECT_TOKEN_FILE: /run/secrets/op_connect_token
    secrets:
      - op_connect_token
    volumes:
      - ./env.template:/templates/woodpecker.template:ro
      - /mnt/apps01/appdata/woodpecker/secrets:/secrets
    networks:
      - op-connect
    command: >
      sh -ec "
      export OP_CONNECT_TOKEN=$$(cat /run/secrets/op_connect_token) &&
      op inject -i /templates/woodpecker.template -o /secrets/woodpecker.env -f &&
      chmod 644 /secrets/woodpecker.env &&
      echo 'Secrets injected successfully'
      "

  woodpecker-server:
    image: woodpeckerci/woodpecker-server:v3.13.0-alpine
    user: "0:0"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == barbary
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '2'
          memory: 1024M
        reservations:
          cpus: '0.25'
          memory: 256M
      labels:
        # Homepage dashboard
        homepage.group: "Platform"
        homepage.name: "Woodpecker CI"
        homepage.icon: "woodpecker-ci.png"
        homepage.href: "https://ci.in.hypyr.space"
        homepage.description: "CI/CD pipelines"

        # Caddy reverse proxy
        caddy: ci.in.hypyr.space
        caddy.reverse_proxy: "{{upstreams 8000}}"
        caddy.tls.dns: "cloudflare {env.CLOUDFLARE_API_TOKEN}"

        # AutoKuma monitoring
        kuma.woodpecker.http.name: "Woodpecker CI"
        kuma.woodpecker.http.url: "https://ci.in.hypyr.space"
        kuma.woodpecker.http.interval: "60"
        kuma.woodpecker.http.maxretries: "3"
        kuma.woodpecker.http.accepted_statuscodes: '["200-299"]'
    volumes:
      - /mnt/apps01/appdata/woodpecker:/data
      - /mnt/apps01/appdata/woodpecker/secrets:/secrets:ro
    environment:
      WOODPECKER_SERVER_ADDR: ":8000"
      WOODPECKER_LOG_LEVEL: info
      WOODPECKER_GITEA: "true"
      WOODPECKER_DATABASE_DRIVER: sqlite3
      WOODPECKER_DATABASE_DATASOURCE: /data/woodpecker.db
    networks:
      woodpecker:
      proxy_network:
        aliases:
          - woodpecker-server
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "set -a && [ -f /secrets/woodpecker.env ] && . /secrets/woodpecker.env && set +a &&
       exec /bin/woodpecker-server"

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:v3.13.0-alpine
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == barbary
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '2'
          memory: 2048M
        reservations:
          cpus: '0.25'
          memory: 256M
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /mnt/apps01/appdata/woodpecker/secrets:/secrets:ro
    environment:
      WOODPECKER_SERVER: "woodpecker-server:9000"
      WOODPECKER_AGENT_BACKEND: docker
      WOODPECKER_DOCKER_HOST: unix:///var/run/docker.sock
      WOODPECKER_LOG_LEVEL: info
    networks:
      - woodpecker
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "set -a && [ -f /secrets/woodpecker.env ] && . /secrets/woodpecker.env && set +a &&
       exec /bin/woodpecker-agent"

networks:
  woodpecker:
    driver: overlay
    internal: true
  proxy_network:
    external: true
  op-connect:
    name: op-connect_op-connect
    external: true

secrets:
  op_connect_token:
    external: true
