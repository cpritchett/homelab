services:
  secrets-init:
    image: 1password/op:2@sha256:57d7d6a2bb2b74b2cf8111f6afb2973c74772198f82ea30359a53faae9fff5b1
    environment:
      OP_CONNECT_HOST: http://op-connect-api:8080
      OP_CONNECT_TOKEN_FILE: /run/secrets/op_connect_token
    secrets:
      - op_connect_token
    volumes:
      - ./env.template:/templates/env.template:ro
      - /mnt/apps01/appdata/forgejo/secrets:/secrets
    networks:
      - op-connect
    command: >
      sh -c "
      export OP_CONNECT_TOKEN=$$(cat /run/secrets/op_connect_token) &&
      op inject -i /templates/env.template -o /secrets/postgres.env &&
      echo 'Secrets injected successfully'
      "
    restart: "no"

  forgejo-db:
    image: postgres:18@sha256:5773fe724c49c42a7a9ca70202e11e1dff21fb7235b335a73f39297d200b73a2
    restart: unless-stopped
    volumes:
      - /mnt/data01/appdata/forgejo/postgres:/var/lib/postgresql/data
      - /mnt/apps01/appdata/forgejo/secrets:/secrets:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U forgejo"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - forgejo
    depends_on:
      - secrets-init
    # env_file removed - using entrypoint wrapper to load env at runtime
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "set -a && [ -f /secrets/postgres.env ] && . /secrets/postgres.env && set +a &&
       exec docker-entrypoint.sh postgres"

  forgejo:
    image: codeberg.org/forgejo/forgejo:14.0.2@sha256:fa8ce5aba7c20e106c649e00da1f568e8f39c58f1706bcf4f6921f16aaf5ba48
    restart: unless-stopped
    depends_on:
      - forgejo-db
      - secrets-init
    environment:
      USER_UID: 1000
      USER_GID: 1000
      DB_TYPE: postgres
      DB_HOST: forgejo-db
      CONTAINER_REGISTRY_ENABLED: "true"
    volumes:
      - /mnt/apps01/appdata/forgejo:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - /mnt/apps01/appdata/forgejo/secrets:/secrets:ro
    ports:
      - "3022:22"
    labels:
      caddy: git.in.hypyr.space
      caddy.tls.dns: "cloudflare {env.CLOUDFLARE_API_TOKEN}"
      caddy.reverse_proxy: "{{upstreamDialer \"forgejo:3000\"}}"
    networks:
      forgejo:
      proxy_network:
        aliases:
          - forgejo
    # env_file removed - using entrypoint wrapper to load env at runtime
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "set -a && [ -f /secrets/postgres.env ] && . /secrets/postgres.env && set +a &&
       exec /usr/local/bin/docker-entrypoint.sh web"

networks:
  forgejo:
    driver: overlay
    internal: true
  proxy_network:
    external: true
  op-connect:
    external: true



secrets:
  op_connect_token:
    external: true
