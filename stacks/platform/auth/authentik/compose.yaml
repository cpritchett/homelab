services:
  secrets-init:
    image: 1password/op:2@sha256:57d7d6a2bb2b74b2cf8111f6afb2973c74772198f82ea30359a53faae9fff5b1
    environment:
      OP_CONNECT_HOST: http://op-connect-api:8080
      OP_CONNECT_TOKEN_FILE: /run/secrets/op_connect_token
    secrets:
      - op_connect_token
    volumes:
      - ./env.template:/templates/authentik.template:ro
      - ./postgres.template:/templates/postgres.template:ro
      - /mnt/apps01/appdata/authentik/secrets:/secrets
    networks:
      - op-connect
    command: >
      sh -c "
      export OP_CONNECT_TOKEN=$$(cat /run/secrets/op_connect_token) &&
      op inject -i /templates/authentik.template -o /secrets/authentik.env -f &&
      op inject -i /templates/postgres.template -o /secrets/postgres.env -f &&
      echo 'Secrets injected successfully'
      "
    restart: "no"

  postgresql:
    image: postgres:18@sha256:5773fe724c49c42a7a9ca70202e11e1dff21fb7235b335a73f39297d200b73a2
    restart: unless-stopped
    volumes:
      - /mnt/data01/appdata/authentik/postgres:/var/lib/postgresql
      - /mnt/apps01/appdata/authentik/secrets:/secrets:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-authentik}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - authentik
    depends_on:
      - secrets-init
    # env_file removed - using entrypoint wrapper to load env at runtime
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "set -a && [ -f /secrets/postgres.env ] && . /secrets/postgres.env && set +a &&
       exec docker-entrypoint.sh postgres"

  redis:
    image: redis:8-alpine@sha256:4eec4565e45aa0b3966554c866bc73211e281b0b3d89fe9a33c982e6faca809d
    restart: unless-stopped
    command: ["redis-server", "--save", "60", "1"]
    volumes:
      - /mnt/data01/appdata/authentik/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - authentik

  authentik-server:
    image: ghcr.io/goauthentik/server:2025.12.2@sha256:7cc1bc10aa2b11b998fb087d3ec4d32db31a3da9871d1ff08b95a6e94df991fd
    restart: unless-stopped
    volumes:
      - /mnt/apps01/appdata/authentik/media:/media
      - /mnt/apps01/appdata/authentik/custom-templates:/templates
      - /mnt/apps01/appdata/authentik/secrets:/secrets:ro
    environment:
      # Core connections
      AUTHENTIK_REDIS__HOST: "redis"
      AUTHENTIK_POSTGRESQL__HOST: "postgresql"
    depends_on:
      - secrets-init
      - postgresql
      - redis
    labels:
      caddy: auth.in.hypyr.space
      caddy.tls.dns: "cloudflare {env.CLOUDFLARE_API_TOKEN}"
      caddy.reverse_proxy: "{{upstreams 9000}}"
    networks:
      authentik:
      proxy_network:
        aliases:
          - authentik-server
    # env_file removed - using entrypoint wrapper to load env at runtime
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "set -a && [ -f /secrets/authentik.env ] && . /secrets/authentik.env && set +a &&
       exec /lifecycle/ak server"

  authentik-worker:
    image: ghcr.io/goauthentik/server:2025.12.2@sha256:7cc1bc10aa2b11b998fb087d3ec4d32db31a3da9871d1ff08b95a6e94df991fd
    restart: unless-stopped
    volumes:
      - /mnt/apps01/appdata/authentik/media:/media
      - /mnt/apps01/appdata/authentik/custom-templates:/templates
      - /mnt/apps01/appdata/authentik/secrets:/secrets:ro
    environment:
      # Core connections
      AUTHENTIK_REDIS__HOST: "redis"
      AUTHENTIK_POSTGRESQL__HOST: "postgresql"
    depends_on:
      - secrets-init
      - postgresql
      - redis
    networks:
      - authentik
    # env_file removed - using entrypoint wrapper to load env at runtime
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "set -a && [ -f /secrets/authentik.env ] && . /secrets/authentik.env && set +a &&
       exec /lifecycle/ak worker"

networks:
  # NOTE: The authentik network driver has been changed from "bridge" to "overlay" to support Swarm mode.
  # This is a breaking change: when upgrading from a previous version using a different driver,
  # you must fully remove and redeploy the authentik stack for the new network driver to take effect.
  # NOTE: The authentik network driver has been changed from "bridge" to "overlay" to support Swarm mode.
  # This is a breaking change: when upgrading from a previous version using a different driver,
  # you must fully remove and redeploy the authentik stack for the new network driver to take effect.
  authentik:
    driver: overlay
  proxy_network:
    external: true
  op-connect:
    external: true
    name: op-connect_op-connect



secrets:
  op_connect_token:
    external: true
