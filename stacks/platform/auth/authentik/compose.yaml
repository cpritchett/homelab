services:
  postgresql:
    image: postgres:18@sha256:5773fe724c49c42a7a9ca70202e11e1dff21fb7235b335a73f39297d200b73a2
    restart: unless-stopped
    env_file:
      - /mnt/apps01/secrets/authentik/postgres.env
    volumes:
      - /mnt/data01/appdata/authentik/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-authentik}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - authentik

  redis:
    image: redis:8-alpine@sha256:4eec4565e45aa0b3966554c866bc73211e281b0b3d89fe9a33c982e6faca809d
    restart: unless-stopped
    command: ["redis-server", "--save", "60", "1"]
    volumes:
      - /mnt/data01/appdata/authentik/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - authentik

  authentik-server:
    image: ghcr.io/goauthentik/server:2025.12.2@sha256:7cc1bc10aa2b11b998fb087d3ec4d32db31a3da9871d1ff08b95a6e94df991fd
    restart: unless-stopped
    env_file:
      - /mnt/apps01/secrets/authentik/authentik.env
    environment:
      # Core settings (normally from env_file, but explicit for clarity and fallbacks)
      AUTHENTIK_SECRET_KEY: "${AUTHENTIK_SECRET_KEY}"
      AUTHENTIK_REDIS__HOST: "redis"
      AUTHENTIK_POSTGRESQL__HOST: "postgresql"
      AUTHENTIK_POSTGRESQL__USER: "${AUTHENTIK_POSTGRESQL__USER:-authentik}"
      AUTHENTIK_POSTGRESQL__NAME: "${AUTHENTIK_POSTGRESQL__NAME:-authentik}"
      AUTHENTIK_POSTGRESQL__PASSWORD: "${AUTHENTIK_POSTGRESQL__PASSWORD}"
      # Security and privacy
      AUTHENTIK_DISABLE_STARTUP_ANALYTICS: "true"
      AUTHENTIK_ERROR_REPORTING__ENABLED: "false"
      # Public-facing configuration
      AUTHENTIK_COOKIE_DOMAIN: "${AUTHENTIK_COOKIE_DOMAIN:-.in.hypyr.space}"
      AUTHENTIK_HOST: "${AUTHENTIK_HOST:-https://auth.in.hypyr.space}"
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - /mnt/apps01/appdata/authentik/media:/media
      - /mnt/apps01/appdata/authentik/custom-templates:/templates
    labels:
      caddy: auth.in.hypyr.space
      caddy.tls.dns: "cloudflare {env.CLOUDFLARE_API_TOKEN}"
      caddy.reverse_proxy: "{{upstreams 9000}}"
    networks:
      - authentik
      - proxy_network

  authentik-worker:
    image: ghcr.io/goauthentik/server:2025.12.2@sha256:7cc1bc10aa2b11b998fb087d3ec4d32db31a3da9871d1ff08b95a6e94df991fd
    restart: unless-stopped
    env_file:
      - /mnt/apps01/secrets/authentik/authentik.env
    environment:
      # Core settings (normally from env_file, but explicit for clarity and fallbacks)
      AUTHENTIK_SECRET_KEY: "${AUTHENTIK_SECRET_KEY}"
      AUTHENTIK_REDIS__HOST: "redis"
      AUTHENTIK_POSTGRESQL__HOST: "postgresql"
      AUTHENTIK_POSTGRESQL__USER: "${AUTHENTIK_POSTGRESQL__USER:-authentik}"
      AUTHENTIK_POSTGRESQL__NAME: "${AUTHENTIK_POSTGRESQL__NAME:-authentik}"
      AUTHENTIK_POSTGRESQL__PASSWORD: "${AUTHENTIK_POSTGRESQL__PASSWORD}"
      # Security and privacy
      AUTHENTIK_DISABLE_STARTUP_ANALYTICS: "true"
      AUTHENTIK_ERROR_REPORTING__ENABLED: "false"
    command: worker
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - /mnt/apps01/appdata/authentik/media:/media
      - /mnt/apps01/appdata/authentik/custom-templates:/templates
    networks:
      - authentik

networks:
  authentik:
    driver: bridge
  proxy_network:
    external: true
