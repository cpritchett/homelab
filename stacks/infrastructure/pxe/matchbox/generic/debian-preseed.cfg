### Debian 12 (Bookworm) Preseed — Swarm Node
### Go-templated by Matchbox. Variables from group metadata:
###   {{.hostname}}          — node hostname
###   {{.ssh_authorized_key}} — SSH public key for deploy user
###   {{.static_ip}}         — static IP (informational; DHCP used for install)
###   {{.gateway}}           — default gateway
###   {{.nameserver}}        — DNS server

# ── Locale & Keyboard ────────────────────────────────────
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us
d-i console-setup/ask_detect boolean false

# ── Network ──────────────────────────────────────────────
# Use DHCP during install (UniFi assigns static lease by MAC).
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string {{.hostname}}
d-i netcfg/get_domain string in.hypyr.space

# ── Mirror ───────────────────────────────────────────────
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

# ── Clock & Timezone ─────────────────────────────────────
d-i clock-setup/utc boolean true
d-i time/zone string America/Chicago
d-i clock-setup/ntp boolean true

# ── Disk Partitioning ────────────────────────────────────
# Use entire disk with LVM. Single partition for simplicity.
d-i partman-auto/method string lvm
d-i partman-auto-lvm/guided_size string max
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
d-i partman-auto/choose_recipe select atomic
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# ── Root Account ─────────────────────────────────────────
# Disable root login; use sudo via deploy user.
d-i passwd/root-login boolean false

# ── Deploy User ──────────────────────────────────────────
d-i passwd/user-fullname string Deploy
d-i passwd/username string deploy
# Locked password — SSH key only.
d-i passwd/user-password-crypted string !
d-i user-setup/allow-password-weak boolean true

# ── Package Selection ────────────────────────────────────
tasksel tasksel/first multiselect standard, ssh-server
d-i pkgsel/include string openssh-server curl ca-certificates gnupg sudo qemu-guest-agent
d-i pkgsel/upgrade string full-upgrade
d-i pkgsel/update-policy select unattended-upgrades
popularity-contest popularity-contest/participate boolean false

# ── Bootloader ───────────────────────────────────────────
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string default

# ── Late Command (post-install) ──────────────────────────
# 1. Configure deploy user with passwordless sudo and SSH key
# 2. Enable qemu-guest-agent (Proxmox VMs)
# Docker, NFS, Periphery, and hardening are handled by Ansible post-install.
d-i preseed/late_command string \
  in-target sh -c 'echo "deploy ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/deploy && chmod 440 /etc/sudoers.d/deploy'; \
  in-target mkdir -p /home/deploy/.ssh; \
  in-target sh -c 'echo "{{.ssh_authorized_key}}" > /home/deploy/.ssh/authorized_keys'; \
  in-target chmod 700 /home/deploy/.ssh; \
  in-target chmod 600 /home/deploy/.ssh/authorized_keys; \
  in-target chown -R deploy:deploy /home/deploy/.ssh; \
  in-target systemctl enable qemu-guest-agent || true

# ── Finish ───────────────────────────────────────────────
d-i finish-install/reboot_in_progress note
