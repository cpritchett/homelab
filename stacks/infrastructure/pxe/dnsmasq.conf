# dnsmasq — proxyDHCP + TFTP for PXE boot
#
# UniFi handles DHCP (IP assignment). dnsmasq only provides:
#   1. proxyDHCP responses (boot filename / next-server)
#   2. TFTP serving of iPXE firmware (undionly.kpxe, ipxe.efi)
#
# iPXE firmware then chains to Matchbox HTTP for boot profiles.

# ── General ─────────────────────────────────────────────
# Stay in foreground (required for container runtimes).
keep-in-foreground

# ── ProxyDHCP ─────────────────────────────────────────────
# Don't issue IPs — respond only with boot parameters.
dhcp-range=10.0.5.0,proxy
port=0
log-dhcp

# ── TFTP ──────────────────────────────────────────────────
# Serve iPXE firmware bundled in the dnsmasq container image.
enable-tftp
tftp-root=/var/lib/tftpboot

# ── BIOS PXE → iPXE firmware ─────────────────────────────
dhcp-match=set:bios,option:client-arch,0
dhcp-boot=tag:bios,undionly.kpxe

# ── UEFI PXE → iPXE firmware ─────────────────────────────
dhcp-match=set:efi32,option:client-arch,6
dhcp-boot=tag:efi32,ipxe.efi
dhcp-match=set:efibc,option:client-arch,7
dhcp-boot=tag:efibc,ipxe.efi
dhcp-match=set:efi64,option:client-arch,9
dhcp-boot=tag:efi64,ipxe.efi

# ── iPXE chainload → Matchbox HTTP ───────────────────────
# Once iPXE firmware is loaded, it re-DHCPs with the iPXE user-class.
# Redirect it to Matchbox for MAC-based profile matching.
dhcp-userclass=set:ipxe,iPXE
dhcp-boot=tag:ipxe,http://10.0.5.121:8480/boot.ipxe
