name: talos-templates

permissions:
  contents: read

on:
  pull_request:
    paths:
      - 'talos/templates/**'
      - 'talos/values/**'
      - 'talos/render.sh'
      - 'scripts/test-talos-templates.sh'
  push:
    branches: [ main, master ]
    paths:
      - 'talos/templates/**'
      - 'talos/values/**'
      - 'talos/render.sh'
      - 'scripts/test-talos-templates.sh'

jobs:
  test_templates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ytt
        run: |
          curl -sL https://carvel.dev/install.sh | bash
          echo "✓ ytt installed: $(ytt --version)"

      - name: Render all nodes
        run: |
          cd talos
          ./render.sh all

      - name: Validate rendered configs
        run: |
          echo "Validating rendered Talos configs..."
          
          # Check each rendered file exists and has content
          for node in home01 home02 home04 home05; do
            file="talos/rendered/${node}.yaml"
            if [[ ! -f "$file" ]]; then
              echo "❌ Missing: $file"
              exit 1
            fi
            lines=$(wc -l < "$file")
            if [[ $lines -lt 100 ]]; then
              echo "❌ $file too short (${lines} lines)"
              exit 1
            fi
            echo "✓ ${node}: ${lines} lines"
          done

      - name: Verify node differentiation
        run: |
          echo "Checking node-specific values..."
          
          # home01
          grep -q "hostname: home01.hypyr.space" talos/rendered/home01.yaml
          grep -q "10.0.5.215/24" talos/rendered/home01.yaml
          echo "✓ home01: hostname and IP correct"
          
          # home04 (P520 - different hardware)
          grep -q "hostname: home04.hypyr.space" talos/rendered/home04.yaml
          grep -q "10.0.5.92/24" talos/rendered/home04.yaml
          # P520 uses interfaces list, not deviceSelectors
          if grep -q "deviceSelectors:" talos/rendered/home04.yaml; then
            echo "❌ home04 should use interfaces, not deviceSelectors"
            exit 1
          fi
          echo "✓ home04: hostname, IP, and bond config correct"

      - name: Verify 1Password references preserved
        run: |
          echo "Checking 1Password references..."
          
          # Count op:// references (should be 13+)
          count=$(grep -c "op://homelab/talos/" talos/rendered/home01.yaml || true)
          if [[ $count -lt 13 ]]; then
            echo "❌ Expected ≥13 op:// references, found $count"
            exit 1
          fi
          echo "✓ Found $count op:// references"
          
          # Check critical secrets
          grep -q "op://homelab/talos/MACHINE_TOKEN" talos/rendered/home01.yaml
          grep -q "op://homelab/talos/CLUSTER_CA_CRT" talos/rendered/home01.yaml
          echo "✓ Critical secrets present"

      - name: Verify multi-document output
        run: |
          echo "Checking multi-document structure..."
          
          for node in home01 home02 home04 home05; do
            file="talos/rendered/${node}.yaml"
            
            # VolumeConfig
            if ! grep -q "kind: VolumeConfig" "$file"; then
              echo "❌ ${node}: missing VolumeConfig"
              exit 1
            fi
            
            # UserVolumeConfig
            if ! grep -q "kind: UserVolumeConfig" "$file"; then
              echo "❌ ${node}: missing UserVolumeConfig"
              exit 1
            fi
            
            echo "✓ ${node}: multi-document structure valid"
          done

      - name: Verify VLANs on all nodes
        run: |
          echo "Checking VLAN configuration..."
          
          # All nodes should have VLANs 10 and 48
          for node in home01 home02 home04 home05; do
            vlan_count=$(grep -c "vlanId:" talos/rendered/${node}.yaml || true)
            if [[ $vlan_count -lt 2 ]]; then
              echo "❌ ${node}: expected ≥2 VLANs, found $vlan_count"
              exit 1
            fi
            
            # Verify specific VLANs
            if ! grep -q "vlanId: 10" talos/rendered/${node}.yaml; then
              echo "❌ ${node}: missing VLAN 10"
              exit 1
            fi
            if ! grep -q "vlanId: 48" talos/rendered/${node}.yaml; then
              echo "❌ ${node}: missing VLAN 48"
              exit 1
            fi
            
            echo "✓ ${node}: has VLANs 10 and 48"
          done
