name: security-pii-secrets

on:
  pull_request:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 7 * * 1'  # Mondays 07:00 UTC

permissions:
  contents: read

jobs:
  pii_secrets_gate:
    name: pii_secrets_gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install mise
        uses: jdx/mise-action@v2
        with:
          install: true

      - name: Run staged/diff scan (gitleaks protect)
        env:
          BASE_REF: ${{ github.base_ref || github.event.repository.default_branch || 'main' }}
        run: |
          set -euo pipefail
          mise install
          git fetch origin "$BASE_REF":"refs/remotes/origin/${BASE_REF}" --depth=200 || true
          BASE_POINT=$(git merge-base HEAD "origin/${BASE_REF}" || git rev-parse HEAD^ || git rev-parse HEAD)
          gitleaks detect --redact --config .gitleaks.toml --gitleaks-ignore-path .gitleaks.allowlist --log-opts="${BASE_POINT}..HEAD"

  pii_secrets_full:
    name: pii_secrets_full
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install mise
        uses: jdx/mise-action@v2
        with:
          install: true

      - name: Full repo scan (gitleaks detect)
        run: |
          mise install
          gitleaks detect --redact --config .gitleaks.toml --gitleaks-ignore-path .gitleaks.allowlist --report-path gitleaks-report.json

  pii_secrets_test:
    name: pii_secrets_test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install mise
        uses: jdx/mise-action@v2
        with:
          install: true

      - name: Run synthetic fixture test
        run: |
          mise install
          bash scripts/security-test.sh
